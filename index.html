<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MRV Gestão</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root { --primary: #00D084; --secondary: #2C3E50; --bg: #F0F2F5; --surface: #FFFFFF; --text: #1F2937; --danger: #EF4444; --success: #10B981; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: var(--text); -webkit-font-smoothing: antialiased; }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }

        .dashboard-header { background: var(--surface); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid var(--primary); }
        .control-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; margin-top: 15px; }
        select, input[type="date"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB; background: #F9FAFB; font-weight: 600; color: var(--secondary); font-size: 0.9rem; appearance: none; box-sizing: border-box; }

        .floor-card { background: var(--surface); border-radius: 12px; padding: 15px; padding-top: 40px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); position: relative; margin-bottom: 15px; }
        .floor-badge { position: absolute; top: 10px; left: 10px; background: var(--secondary); color: white; font-size: 0.75rem; font-weight: 700; padding: 4px 10px; border-radius: 6px; }
        .floor-layout { display: flex; flex-direction: column; gap: 8px; }
        .row-units { display: flex; gap: 8px; justify-content: center; }
        .row-hall { display: flex; justify-content: center; margin: 5px 0; }

        .unit { flex: 1; height: 48px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; cursor: pointer; background: #F3F4F6; color: #9CA3AF; transition: transform 0.1s; border: 1px solid transparent; user-select: none; }
        .unit:active { transform: scale(0.95); }
        .unit.hall-btn { max-width: 140px; height: 32px; background: transparent; border: 2px dashed #D1D5DB; color: #6B7280; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }

        .unit.ok { background: var(--success); color: white; }
        .unit.pendente { background: var(--danger); color: white; animation: pulse 2s infinite; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: white; width: 90%; max-width: 380px; padding: 24px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .label-section { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #9CA3AF; margin-bottom: 6px; display: block; margin-top: 15px; }
        
        .btn-group { display: flex; gap: 10px; margin-bottom: 5px; }
        .btn-opt { flex: 1; padding: 14px; border-radius: 10px; border: 2px solid #F3F4F6; background: white; font-weight: 600; cursor: pointer; text-align: center; color: var(--text); display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-opt.sel-ok { background: var(--success); color: white; border-color: var(--success); }
        .btn-opt.sel-err { background: var(--danger); color: white; border-color: var(--danger); }

        textarea { width: 100%; padding: 12px; border: 1px solid #D1D5DB; border-radius: 8px; height: 70px; font-family: inherit; margin-bottom: 10px; box-sizing: border-box; resize: none; }
        .btn-save { width: 100%; padding: 16px; background: var(--secondary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 1rem; }

        /* RELATÓRIO STYLE */
        .btn-report { background: #E0E7FF; color: #3730A3; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px; margin-top: 10px; width: 100%; justify-content: center; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .report-table th { text-align: left; color: #6B7280; font-weight: 700; padding-bottom: 8px; border-bottom: 2px solid #E5E7EB; }
        .report-table td { padding: 10px 0; border-bottom: 1px solid #F3F4F6; color: var(--secondary); }
        .metric-box { background: #F9FAFB; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #E5E7EB; }
        .metric-val { font-size: 1.2rem; font-weight: 800; color: var(--secondary); display: block; }
        .metric-lbl { font-size: 0.7rem; color: #6B7280; font-weight: 700; text-transform: uppercase; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1F2937; color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.9rem; font-weight: 600; z-index: 200; display: flex; align-items: center; gap: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://iisvzfzcpxxgkasmteft.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlpc3Z6ZnpjcHh4Z2thc210ZWZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNzcyOTgsImV4cCI6MjA3OTk1MzI5OH0.HxkLQxXb8yohwP9nK6IfxGzxH1ItlMwmXpHVZb6qlGo';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const TORRES = ["Torre 5", "Torre 2", "Torre 3", "Torre 4"];
        const FASES = ["POS FORMA", "ESQUADRIAS", "IMPERMEABILIZAÇÃO", "ALVENARIA BLOCO", "FECHAMENTO SHAFT"];
        const ANDARES = 8;

        const EQUIPES_POR_FASE = {
            "POS FORMA": ["LD", "MOP", "VITHAL"],
            "ESQUADRIAS": ["MOP AURIAN", "MOP HELDE"],
            "IMPERMEABILIZAÇÃO": ["LD BRIAGE"],
            "ALVENARIA BLOCO": ["LD"],
            "FECHAMENTO SHAFT": ["LW", "TOP LIMPE"]
        };

        function App() {
            const [torre, setTorre] = useState(TORRES[0]);
            const [fase, setFase] = useState(FASES[0]);
            const [dados, setDados] = useState({});
            
            // MODAIS
            const [modalOpen, setModalOpen] = useState(false);
            const [reportOpen, setReportOpen] = useState(false); // Novo Modal de Relatório
            
            const [itemEditando, setItemEditando] = useState(null);
            const [toast, setToast] = useState(null);

            // Carrega dados da Torre/Fase atual
            useEffect(() => {
                async function load() {
                    setDados({});
                    const { data } = await supabase.from('vistorias').select('*').eq('torre', torre).eq('fase', fase);
                    const map = {};
                    if(data) data.forEach(i => map[i.unidade] = i);
                    setDados(map);
                }
                load();
            }, [torre, fase]);

            // Salva Vistoria
            const save = async (status, obs, equipe) => {
                const idUnidade = itemEditando.id.toString();
                const idUnico = `${torre}_${fase}_${idUnidade}`.trim();
                const obsFinal = status === 'ok' ? '' : obs; 

                setDados(prev => ({
                    ...prev, 
                    [idUnidade]: { ...prev[idUnidade], status, obs: obsFinal, equipe }
                }));
                
                setModalOpen(false);
                setToast("Salvo com sucesso!");
                setTimeout(()=>setToast(null), 2500);

                const { error } = await supabase.from('vistorias').upsert({
                    id: idUnico, torre, fase, unidade: idUnidade,
                    status, obs: obsFinal, equipe, updated_at: new Date()
                }, { onConflict: 'id' });

                if (error) { console.error(error); setToast("Erro ao salvar!"); }
            };

            const getItem = (id) => dados[id] || {status: null, obs: '', equipe: ''};
            
            // Lógica do Clique
            const handleUnitClick = (ap) => {
                setItemEditando({ ...getItem(ap), id: ap });
                setModalOpen(true);
            };

            const totalUnits = ANDARES * 9;
            const doneCount = Object.values(dados).filter(d => d.status === 'ok').length;
            const progresso = Math.round((doneCount / totalUnits) * 100) || 0;

            return (
                <div className="container">
                    {toast && <div className="toast"><i className="ph-fill ph-check-circle"></i> {toast}</div>}

                    <div className="dashboard-header">
                        <h1 style={{margin:0, color:'var(--secondary)'}}>MRV Gestão</h1>
                        
                        <div className="control-grid">
                            <select value={torre} onChange={e=>setTorre(e.target.value)}>{TORRES.map(t=><option key={t}>{t}</option>)}</select>
                            <select value={fase} onChange={e=>setFase(e.target.value)}>{FASES.map(f=><option key={f}>{f}</option>)}</select>
                        </div>

                        {/* BOTÃO DE RELATÓRIO NOVO */}
                        <button className="btn-report" onClick={()=>setReportOpen(true)}>
                            <i className="ph-bold ph-chart-bar"></i> Gerar Relatório de Equipes
                        </button>

                        <div style={{marginTop:15}}>
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:5, fontSize:'0.7rem', fontWeight:'bold', color:'#666'}}>
                                <span>CONCLUSÃO TORRE</span> <span>{progresso}%</span>
                            </div>
                            <div style={{height:8, background:'#E5E7EB', borderRadius:10, overflow:'hidden'}}>
                                <div style={{width:`${progresso}%`, height:'100%', background:'var(--primary)', transition:'width 0.5s ease'}}></div>
                            </div>
                        </div>
                    </div>

                    <div className="building-card">
                        {Array.from({length: ANDARES}, (_, i) => {
                            const andar = ANDARES - i;
                            return (
                                <div key={andar} className="floor-card">
                                    <div className="floor-badge">{andar}º PAV</div>
                                    <div className="floor-layout">
                                        <div className="row-units">
                                            {[5,6,7,8].map(n => {
                                                const ap = (andar*100)+n;
                                                return <Unit key={ap} id={ap} data={getItem(ap)} onClick={()=>handleUnitClick(ap)} />
                                            })}
                                        </div>
                                        <div className="row-hall">
                                            <Unit id={`HALL-${andar}`} label="HALL" isHall={true} data={getItem(`HALL-${andar}`)} onClick={()=>handleUnitClick(`HALL-${andar}`)} />
                                        </div>
                                        <div className="row-units">
                                            {[1,2,3,4].map(n => {
                                                const ap = (andar*100)+n;
                                                return <Unit key={ap} id={ap} data={getItem(ap)} onClick={()=>handleUnitClick(ap)} />
                                            })}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {modalOpen && <ModalVistoria item={itemEditando} faseAtual={fase} onClose={()=>setModalOpen(false)} onSave={save} />}
                    
                    {reportOpen && <ModalRelatorio onClose={()=>setReportOpen(false)} supabase={supabase} />}
                </div>
            );
        }

        function Unit({ id, label, isHall, data, onClick }) {
            let cls = `unit ${isHall ? 'hall-btn' : ''}`;
            if(data.status === 'ok') cls += ' ok';
            if(data.status === 'pendente') cls += ' pendente';
            let content = label || id;
            if(!isHall && data.status === 'ok') content = <i className="ph-bold ph-check"></i>;
            if(!isHall && data.status === 'pendente') content = <i className="ph-bold ph-warning"></i>;
            return <div className={cls} onClick={onClick}>{content}</div>;
        }

        // --- NOVO MODAL DE RELATÓRIO ---
        function ModalRelatorio({ onClose, supabase }) {
            const [dtInicio, setDtInicio] = useState('');
            const [dtFim, setDtFim] = useState('');
            const [loading, setLoading] = useState(false);
            const [resultado, setResultado] = useState(null);

            const gerar = async () => {
                if(!dtInicio || !dtFim) return alert("Selecione as datas!");
                setLoading(true);
                
                // Busca TUDO no período (independente de torre)
                const { data, error } = await supabase
                    .from('vistorias')
                    .select('*')
                    .gte('updated_at', dtInicio + 'T00:00:00')
                    .lte('updated_at', dtFim + 'T23:59:59');

                if(data) {
                    const stats = {};
                    data.forEach(item => {
                        const eq = item.equipe || "SEM EQUIPE";
                        if(!stats[eq]) stats[eq] = { total: 0, ok: 0, pendente: 0 };
                        
                        stats[eq].total++;
                        if(item.status === 'ok') stats[eq].ok++;
                        if(item.status === 'pendente') stats[eq].pendente++;
                    });
                    setResultado(stats);
                }
                setLoading(false);
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e=>e.stopPropagation()}>
                        <h3 style={{marginTop:0, color:'var(--secondary)'}}>Relatório de Produtividade</h3>
                        
                        <div style={{display:'flex', gap:10, marginBottom:15}}>
                            <div style={{flex:1}}>
                                <span className="label-section" style={{marginTop:0}}>DE</span>
                                <input type="date" value={dtInicio} onChange={e=>setDtInicio(e.target.value)} />
                            </div>
                            <div style={{flex:1}}>
                                <span className="label-section" style={{marginTop:0}}>ATÉ</span>
                                <input type="date" value={dtFim} onChange={e=>setDtFim(e.target.value)} />
                            </div>
                        </div>

                        <button className="btn-save" onClick={gerar} disabled={loading} style={{background: loading ? '#ccc' : 'var(--primary)'}}>
                            {loading ? 'CALCULANDO...' : 'GERAR RELATÓRIO'}
                        </button>

                        {resultado && (
                            <div style={{marginTop:20}}>
                                <span className="label-section">RESULTADO POR EQUIPE</span>
                                <table className="report-table">
                                    <thead>
                                        <tr>
                                            <th>Equipe</th>
                                            <th style={{textAlign:'center'}}>OK</th>
                                            <th style={{textAlign:'center'}}>PEND</th>
                                            <th style={{textAlign:'right'}}>% Aprov</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.keys(resultado).map(eq => {
                                            const r = resultado[eq];
                                            const perc = Math.round((r.ok / r.total) * 100);
                                            return (
                                                <tr key={eq}>
                                                    <td>{eq}</td>
                                                    <td style={{textAlign:'center', fontWeight:'bold', color:'var(--success)'}}>{r.ok}</td>
                                                    <td style={{textAlign:'center', fontWeight:'bold', color:'var(--danger)'}}>{r.pendente}</td>
                                                    <td style={{textAlign:'right', fontWeight:'800'}}>{perc}%</td>
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        <button onClick={onClose} style={{background:'transparent', border:'none', color:'#666', width:'100%', padding:15, marginTop:10, cursor:'pointer'}}>Fechar</button>
                    </div>
                </div>
            )
        }

        // --- MODAL DE VISTORIA (ANTIGO) ---
        function ModalVistoria({ item, faseAtual, onClose, onSave }) {
            const [status, setStatus] = useState(item.status);
            const [obs, setObs] = useState(item.obs || "");
            const [equipe, setEquipe] = useState(item.equipe || ""); 

            const listaEquipes = EQUIPES_POR_FASE[faseAtual] || [];

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e=>e.stopPropagation()}>
                        <h3 style={{marginTop:0, color:'var(--secondary)'}}>{String(item.id).includes('HALL')?'Hall':'Apto '+item.id}</h3>
                        
                        <span className="label-section">1. SELECIONE A EQUIPE</span>
                        <select value={equipe} onChange={e=>setEquipe(e.target.value)} style={{marginBottom:15}}>
                            <option value="">-- Selecione --</option>
                            {listaEquipes.map(eq => <option key={eq} value={eq}>{eq}</option>)}
                        </select>

                        <span className="label-section">2. AVALIAÇÃO</span>
                        <div className="btn-group">
                            <div className={`btn-opt ${status==='ok'?'sel-ok':''}`} onClick={()=>setStatus('ok')}>
                                <i className="ph-bold ph-thumbs-up"></i> Aprovado
                            </div>
                            <div className={`btn-opt ${status==='pendente'?'sel-err':''}`} onClick={()=>setStatus('pendente')}>
                                <i className="ph-bold ph-warning-circle"></i> Pendente
                            </div>
                        </div>

                        {status === 'pendente' && (
                            <div style={{animation:'slideUp 0.2s'}}>
                                <span className="label-section" style={{color:'var(--danger)'}}>O QUE ESTÁ ERRADO?</span>
                                <textarea autoFocus placeholder="Descreva a falha..." value={obs} onChange={e=>setObs(e.target.value)}></textarea>
                            </div>
                        )}
                        
                        <button className="btn-save" onClick={()=>onSave(status, obs, equipe)}>SALVAR DADOS</button>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
